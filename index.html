<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>اتجاه القبلة</title>
<style>
  body {
    background: #0d0d0d;
    color: white;
    text-align: center;
    font-family: "Arial", sans-serif;
    margin: 0;
    padding: 0;
  }

  h1 {
    margin: 20px 0;
  }

  .compass-container {
    position: relative;
    margin: 20px auto;
    width: 300px;
    height: 300px;
  }

  /* دائرة الخلفية الذهبية */
  .compass-ring {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
      #d4af37 0deg 15deg,
      #b68e2a 15deg 30deg
    );
    border: 8px solid #d4af37;
  }

  /* السهم (الإبرة) */
  /* السهم (الإبرة) */
.needle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 8px;
  height: 42%;
  background: linear-gradient(to bottom, #ffd700, #b48b02);
  border-radius: 4px;
  transform-origin: 50% 100%;
  transform: translate(-50%, 0) rotate(0deg);
  box-shadow: none !important;   /* منع أي ظل */
  border: none !important;       /* منع أي حواف */
  z-index: 5;
}


  /* النقطة السوداء في مركز البوصلة */
  .needle-center {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 14px;
    height: 14px;
    background: black;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    z-index: 6;
  }

  button {
    background-color: #d4af37;
    color: black;
    border: none;
    padding: 12px 28px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 15px;
    font-weight: bold;
  }

  p {
    margin-top: 15px;
  }

  .success {
    color: #00ff66;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>اتجاه القبلة</h1>

<div class="compass-container">
  <div class="compass-ring"></div>
  <div class="needle"></div>
  <div class="needle-center"></div>
</div>

<button id="start">ابدأ</button>
<p id="status">اضغط ابدأ ثم حرك الهاتف حتى يثبت السهم على القبلة.</p>

<script>
  const needle = document.querySelector('.needle');
  const statusText = document.getElementById('status');

  let qiblaDirection = null; 
  let heading = 0;

  // دالة حساب القبلة حسب إحداثيات المستخدم
  function calculateQibla(lat, lon) {
    const kaabaLat = 21.4225 * Math.PI / 180;
    const kaabaLon = 39.8262 * Math.PI / 180;
    lat = lat * Math.PI / 180;
    lon = lon * Math.PI / 180;

    const y = Math.sin(kaabaLon - lon);
    const x = Math.cos(lat) * Math.tan(kaabaLat) - Math.sin(lat) * Math.cos(kaabaLon - lon);
    const bearing = Math.atan2(y, x);
    return (bearing * 180 / Math.PI + 360) % 360;
  }

  // تفعيل GPS للحصول على موقع المستخدم
  function getLocation() {
    if (!navigator.geolocation) {
      alert("المتصفح لا يدعم تحديد الموقع.");
      return;
    }
    statusText.textContent = "جاري تحديد الموقع...";
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      qiblaDirection = calculateQibla(latitude, longitude);
      statusText.textContent = "تم تحديد القبلة، فعّل البوصلة الآن.";
    }, () => {
      statusText.textContent = "فشل تحديد الموقع. تأكد من تشغيل GPS ومنح الإذن.";
    });
  }

  // تحريك السهم مع بوصلة الجهاز
  function startCompass() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      DeviceOrientationEvent.requestPermission().then(permission => {
        if (permission === 'granted') {
          window.addEventListener('deviceorientation', updateCompass);
        }
      });
    } else {
      window.addEventListener('deviceorientation', updateCompass);
    }
  }

  // تحديث السهم كلما تحرك الجهاز
  function updateCompass(event) {
    heading = event.webkitCompassHeading || (360 - event.alpha);
    if (qiblaDirection !== null) {
      const angle = qiblaDirection - heading;
      needle.style.transform = `translate(-50%, 0) rotate(${angle}deg)`;
      
      //判 إذا السهم مضبوط على القبلة
      if (Math.abs(angle) < 5) {
        statusText.textContent = "اتجاه القبلة صحيح ✅";
        statusText.classList.add('success');
        if (navigator.vibrate) navigator.vibrate(200);
      } else {
        statusText.textContent = "حرك الهاتف حتى يتجه السهم نحو القبلة.";
        statusText.classList.remove('success');
      }
    }
  }

  // عند الضغط على زر ابدأ
  document.getElementById('start').addEventListener('click', () => {
    getLocation();
    startCompass();
  });
</script>

</body>
</html>
