<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 30px; direction: rtl; }
    #compass { width: 250px; transition: transform 0.2s linear; }
    #fallback { width: 250px; height: 250px; border: 2px dashed #555; display: none; 
                align-items: center; justify-content: center; margin: 0 auto; }
    button { padding: 10px 20px; margin-top: 15px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</h2>
  <img id="compass" src="https://i.imgur.com/7bQZs8D.png" onerror="showFallback()">
  <div id="fallback">ğŸ§­ ØµÙˆØ±Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</div>

  <p id="angle">Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡: ...</p>
  <button id="enable">Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨ÙˆØµÙ„Ø©</button>

  <script>
    const compass = document.getElementById("compass");
    const fallback = document.getElementById("fallback");
    const angleText = document.getElementById("angle");
    const button = document.getElementById("enable");

    let qiblaAngle = 0;

    function showFallback() {
      compass.style.display = "none";
      fallback.style.display = "flex";
    }

    // Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù‚Ø¨Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    function calculateQibla(lat, lon) {
      const kaabaLat = 21.4225 * Math.PI/180;
      const kaabaLon = 39.8262 * Math.PI/180;
      const userLat = lat * Math.PI/180;
      const userLon = lon * Math.PI/180;

      let angle = Math.atan2(
        Math.sin(kaabaLon - userLon),
        Math.cos(userLat)*Math.tan(kaabaLat) - Math.sin(userLat)*Math.cos(kaabaLon - userLon)
      );
      angle = angle * 180 / Math.PI;
      return (angle + 360) % 360;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
    navigator.geolocation.getCurrentPosition(position => {
      qiblaAngle = calculateQibla(position.coords.latitude, position.coords.longitude);
    });

    function startCompass() {
      if (typeof DeviceOrientationEvent.requestPermission === "function") {
        DeviceOrientationEvent.requestPermission().then(state => {
          if (state === "granted") {
            window.addEventListener("deviceorientation", rotateCompass);
          }
        });
      } else {
        window.addEventListener("deviceorientation", rotateCompass);
      }
    }

    function rotateCompass(event) {
      let heading = event.webkitCompassHeading || 360 - event.alpha;
      let qiblaDirection = heading - qiblaAngle;
      compass.style.transform = `rotate(${qiblaDirection}deg)`;
      angleText.textContent = "Â°Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù‚Ø¨Ù„Ø©: " + Math.round(qiblaAngle);
    }

    button.onclick = startCompass;
  </script>

</body>
</html>
