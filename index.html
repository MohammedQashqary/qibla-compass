<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø©</title>
  <meta name="theme-color" content="#0b1220">
  <!-- iOS standalone (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2f;
      --accent: #13c2c2;
      --muted: #8aa4c0;
      --text: #e6f7ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic UI", sans-serif;
      display: grid; place-items: center; padding: 16px; }
    .app { width: 100%; max-width: 520px; }
    .card {
      background: linear-gradient(180deg, #12213d 0%, #0d172d 100%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px; padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    header { display:flex; align-items:center; justify-content: space-between; gap:12px; }
    h1 { font-size: 20px; margin: 0; letter-spacing: .5px; }
    .badge { font-size: 12px; color: var(--accent); opacity:.9 }
    .compass-wrap { position: relative; aspect-ratio: 1 / 1; width: 100%; margin: 18px auto; }
    .compass {
      position: absolute; inset: 0; display:grid; place-items:center; border-radius: 50%;
      background: radial-gradient(120% 120% at 50% 50%, #132447 0%, #0d172d 60%, #0a1221 100%);
      border: 1px solid rgba(255,255,255,.06);
    }
    .ring { position:absolute; inset: 8px; border-radius:50%; border: 2px dashed rgba(255,255,255,.08); }
    .needle { position:absolute; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 120px solid var(--accent); filter: drop-shadow(0 6px 14px rgba(19,194,194,.4)); transform-origin: 50% 115px; }
    .tail { position:absolute; width: 0; height:0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 70px solid #ff4d4f; transform-origin: 50% -54px; filter: drop-shadow(0 4px 10px rgba(255,77,79,.35)); opacity:.95 }
    .center-dot { position:absolute; width: 14px; height:14px; background:#fff; border-radius:50%; box-shadow: 0 0 0 5px rgba(19,194,194,.18), inset 0 0 0 2px var(--card); }
    .tick { position:absolute; inset: 14px; border-radius:50%; pointer-events:none; }
    .tick div { position:absolute; left:50%; transform: translateX(-50%); width:2px; height:10px; background: rgba(255,255,255,.2); transform-origin: 50% 136px; }
    .qibla-arrow { position:absolute; top: 8px; left:50%; transform: translateX(-50%); font-size: 12px; color: var(--text); opacity:.8 }
    .readouts { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .pill { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px; text-align:center; }
    .pill small { display:block; color: var(--muted); font-size: 12px; margin-bottom: 4px; }
    .btns { display:flex; gap:10px; margin-top: 12px; flex-wrap: wrap; }
    button { flex:1 1 auto; appearance:none; border:1px solid rgba(255,255,255,.12); background:#0f1b34; color:#e6f7ff; padding:12px; border-radius: 12px; font-weight:600; letter-spacing:.3px; }
    button.primary { background: linear-gradient(180deg,#14dad6,#13c2c2); color:#0a0f18; border:none; }
    button.danger { background: #2a0f12; border-color:#3b1518; color:#ffccc7; }
    .tip { margin-top: 10px; font-size: 12px; color: var(--muted); line-height: 1.6; }
    footer { margin-top: 14px; display:flex; justify-content:space-between; font-size: 12px; color: var(--muted); }
    .ok { color: #95de64; }
    .warn { color: #ffd666; }
    .err { color: #ff7875; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù‚Ø¨Ù„Ø©</h1>
        <span id="status" class="badge">Ø¬Ø§Ù‡Ø²Ø©</span>
      </header>

      <div class="compass-wrap">
        <div class="compass" id="compass">
          <div class="ring"></div>
          <div class="tick" id="ticks"></div>
          <div class="needle" id="needle"></div>
          <div class="tail" id="tail"></div>
          <div class="center-dot"></div>
          <div class="qibla-arrow">â¬‡ï¸ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</div>
        </div>
      </div>

      <div class="readouts">
        <div class="pill"><small>Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù‚Ø¨Ù„Ø©</small><b id="bearingText">â€”Â°</b></div>
        <div class="pill"><small>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬Ù‡Ø§Ø²</small><b id="headingText">â€”Â°</b></div>
        <div class="pill"><small>Ø§Ù„ÙØ§Ø±Ù‚</small><b id="deltaText">â€”Â°</b></div>
        <div class="pill"><small>Ø§Ù„Ù…ÙˆÙ‚Ø¹</small><b id="locText">â€”</b></div>
      </div>

      <div class="btns">
        <button id="grantBtn" class="primary">Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ©</button>
        <button id="locBtn">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button id="resetBtn" class="danger">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</button>
      </div>

      <p class="tip">
        Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø©: ÙŠØ­ØªØ§Ø¬ iOS Ø¥Ù„Ù‰ Ø³Ù…Ø§Ø­ Ø¹Ø¨Ø± Ø²Ø± Â«Ø­Ø³Ø§Ø³Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ©Â». ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± HTTPS. Ø£Ø¨Ù‚Ù Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø´ÙƒÙ„ Ø¹Ù…ÙˆØ¯ÙŠ ÙˆØ­Ø±Ù‘ÙƒÙ‡ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø±Ù‚Ù… 8 Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¯Ù‚Ø©.
      </p>

      <footer>
        <span>Safari & Chrome Ù„Ù„Ø¬ÙˆØ§Ù„</span>
        <span id="secureLabel"></span>
      </footer>
    </div>
  </div>

  <script>
    // Ø«Ø§Ø¨Øª: Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙƒØ¹Ø¨Ø©
    const KAABA = { lat: 21.422487, lon: 39.826206 };

    // Ø¹Ù†Ø§ØµØ± DOM
    const needle = document.getElementById('needle');
    const tail = document.getElementById('tail');
    const bearingText = document.getElementById('bearingText');
    const headingText = document.getElementById('headingText');
    const deltaText = document.getElementById('deltaText');
    const locText = document.getElementById('locText');
    const grantBtn = document.getElementById('grantBtn');
    const locBtn = document.getElementById('locBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusEl = document.getElementById('status');
    const secureLabel = document.getElementById('secureLabel');
    const ticks = document.getElementById('ticks');

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù‚Ø±Øµ
    (function buildTicks(){
      const frag = document.createDocumentFragment();
      for (let i=0;i<36;i++){ // ÙƒÙ„ 10 Ø¯Ø±Ø¬Ø§Øª
        const d = document.createElement('div');
        d.style.transform = `translateX(-50%) rotate(${i*10}deg)`;
        d.style.height = (i%9===0) ? '16px' : (i%3===0 ? '12px' : '8px');
        d.style.background = (i%9===0) ? 'rgba(255,255,255,.35)' : 'rgba(255,255,255,.18)';
        frag.appendChild(d);
      }
      ticks.appendChild(frag);
    })();

    // Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù…Ø§Ù† (HTTPS)
    secureLabel.textContent = location.protocol === 'https:' ? 'ğŸ”’ Ø§ØªØµØ§Ù„ Ø¢Ù…Ù†' : 'âš ï¸ ÙŠÙÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS';

    // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    let userPos = null; // {lat, lon}

    // Ø£Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ©
    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;

    // Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù‚Ø¨Ù„Ø© Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ¹Ø¨Ø© (Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„ Ù…Ø¹ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©)
    function qiblaBearing(fromLat, fromLon){
      // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø³Ù…Øª: https://en.wikipedia.org/wiki/Great-circle_navigation
      const Ï†1 = toRad(fromLat), Î»1 = toRad(fromLon);
      const Ï†2 = toRad(KAABA.lat), Î»2 = toRad(KAABA.lon);
      const y = Math.sin(Î»2-Î»1) * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
      let Î¸ = Math.atan2(y, x);
      Î¸ = (toDeg(Î¸) + 360) % 360; // 0..360 Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„
      return Î¸;
    }

    // ØªØ±Ø´ÙŠØ­ Ø¨Ø³ÙŠØ· Ù„ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª
    function lerp(a,b,t){ return a + (b-a)*t; }

    let targetBearing = null; // Ø¯Ø±Ø¬Ø©
    let currentHeading = null; // Ø¯Ø±Ø¬Ø©
    let displayHeading = 0;

    function updateNeedle(){
      if (targetBearing == null || currentHeading == null) return;
      const delta = ((targetBearing - currentHeading + 540) % 360) - 180; // -180..180
      // Ø¯ÙˆÙ‘Ø± Ø§Ù„Ø¥Ø¨Ø±Ø© Ø¨Ø­ÙŠØ« ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø±Ø£Ø³ Ø§Ù„Ø¬Ù‡Ø§Ø²
      const rotation = currentHeading + delta; // Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ø­Ø³Ø§Ø³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      displayHeading = lerp(displayHeading, rotation, 0.2);
      needle.style.transform = `rotate(${displayHeading}deg)`;
      tail.style.transform = `rotate(${displayHeading+180}deg)`;
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
      bearingText.textContent = `${targetBearing.toFixed(0)}Â°`;
      headingText.textContent = `${currentHeading.toFixed(0)}Â°`;
      deltaText.textContent = `${Math.abs(delta).toFixed(0)}Â°`;
    }

    function setStatus(text, cls=''){
      statusEl.textContent = text;
      statusEl.className = 'badge ' + cls;
    }

    // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø­Ø³Ø§Ø³ Ø§Ù„Ø­Ø±ÙƒØ© (Ù…Ø·Ù„ÙˆØ¨ Ø¹Ù„Ù‰ iOS)
    async function requestMotionPermission(){
      try {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
          const res = await DeviceOrientationEvent.requestPermission();
          if (res === 'granted'){ setStatus('ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø­Ø±ÙƒØ©', 'ok'); startOrientation(); }
          else { setStatus('Ø±ÙÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø­Ø±ÙƒØ©', 'err'); }
        } else {
          // Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ø£Ùˆ iOS Ù‚Ø¯ÙŠÙ…
          setStatus('Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø§ØªØ¬Ø§Ù‡..', 'warn');
          startOrientation();
        }
      } catch(e){ setStatus('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†', 'err'); console.error(e); }
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬Ù‡Ø§Ø²
    function startOrientation(){
      if (!('ondeviceorientationabsolute' in window) && !('ondeviceorientation' in window)){
        setStatus('Ø­Ø³Ø§Ø³ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…', 'err'); return;
      }
      // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù…Ø·Ù„Ù‚ Ø¥Ù† ØªÙˆÙØ±
      const handler = (ev) => {
        let heading = null;
        // iOS Safari ÙŠÙˆÙØ± webkitCompassHeading Ù…Ø¨Ø§Ø´Ø±Ø© (0 = Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
        if (typeof ev.webkitCompassHeading === 'number' && !isNaN(ev.webkitCompassHeading)){
          heading = ev.webkitCompassHeading; // Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ø¹ Ø§ØªØ¬Ø§Ù‡ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø© Ù…Ù† Ø§Ù„Ø´Ù…Ø§Ù„
        } else if (ev.absolute === true && typeof ev.alpha === 'number'){
          // Ø¹Ù„Ù‰ ÙƒØ«ÙŠØ± Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: alpha = 0 Ø¹Ù†Ø¯ Ø§Ù„Ø´Ù…Ø§Ù„ (Ù…Ø¹ Ø¹Ù‚Ø§Ø±Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©)
          // Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ø¹ÙƒÙˆØ³Ø©ØŒ Ø³Ù†Ø­ÙˆÙ‘Ù„ Ø¥Ù„Ù‰ Ø¨ÙˆØµÙ„Ø©: heading = 360 - alpha
          heading = (360 - ev.alpha) % 360;
        } else if (typeof ev.alpha === 'number'){
          // fallback Ù†Ø³Ø¨ÙŠ (Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Ù…Ø¹Ø§ÙŠØ±Ø©)
          heading = (360 - ev.alpha) % 360;
        }
        if (heading != null){
          currentHeading = (heading + orientationOffset) % 360;
          updateNeedle();
        }
      };
      window.addEventListener('deviceorientationabsolute', handler, true);
      window.addEventListener('deviceorientation', handler, true);
      setStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©..', 'ok');
    }

    // Ø²Ø± Ø§Ù„Ø¥Ø°Ù†
    grantBtn.addEventListener('click', requestMotionPermission);

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    function getLocation(){
      if (!('geolocation' in navigator)){
        setStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'err'); return;
      }
      setStatus('Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹..');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        userPos = { lat: latitude, lon: longitude };
        targetBearing = qiblaBearing(userPos.lat, userPos.lon);
        locText.textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
        setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'ok');
        updateNeedle();
      }, err => {
        setStatus('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'err');
        console.warn(err);
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
    }

    locBtn.addEventListener('click', getLocation);

    // Ù…Ø¹Ø§ÙŠØ±Ø© ÙŠØ¯ÙˆÙŠØ© Ø·ÙÙŠÙØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¹ÙƒØ³ Ø§Ù„Ø²ÙˆØ§ÙŠØ§
    let orientationOffset = 0;
    resetBtn.addEventListener('click', ()=>{
      orientationOffset = 0; displayHeading = 0; setStatus('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©', 'warn');
    });

    // Ù„ÙˆØ­Ø© Ù…Ø¹Ø§ÙŠØ±Ø© ØªØ­ØªÙØ¸ Ø¨Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØªØ¹ÙˆÙŠØ¶ (Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ‘Ù„Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¨Ø±Ø©)
    let pressTimer = null;
    document.getElementById('compass').addEventListener('touchstart', ()=>{
      pressTimer = setTimeout(()=>{
        if (targetBearing!=null && currentHeading!=null){
          const delta = ((targetBearing - currentHeading + 540) % 360) - 180;
          orientationOffset = (orientationOffset + delta) % 360;
          setStatus('ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù', 'ok');
        }
      }, 700);
    });
    document.getElementById('compass').addEventListener('touchend', ()=> clearTimeout(pressTimer));

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©: Ø§Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„Ø³Ù…Øª
    if (location.protocol === 'https:') {
      // Ù„Ø§ ØªØ·Ù„Ø¨ Ø§Ù„Ø­Ø±ÙƒØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø£Ù† iOS ÙŠØ­ØªØ§Ø¬ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      getLocation();
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ø°Ù† Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (ØºÙŠØ± Ù…Ø·Ù„ÙˆØ¨ Ø¹Ø§Ø¯Ø©Ù‹)
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission !== 'function'){
      grantBtn.style.display = 'none';
    }
  </script>
</body>
</html>
